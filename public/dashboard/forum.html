<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/forum.css">
    <title>Journey | Forum</title>
</head>

<body>

    <div id="cadastroFoto">
        Digite a URL da foto de perfil: <input type="text" id="ipt_foto">
        <button onclick="enviar()">Enviar</button>
    </div>

    <header>
        <img src="../assets/icon/logotipo.png" style="width: 50px; height: 50px; margin-left: 30px;">
        <span>
            <div>
                <a href="./forum.html"><img src="../assets/icon/botao-home.png" alt=""></a>
                <a href="./dashboard.html"><img src="../assets/icon/painel-de-controle.png" alt=""></a>
            </div>
        </span>
        <span id="perfil">
            <a onclick="abrirFoto()">
            </a>
            <span id="usuarioNome"></span>
            <a onclick="sair()"><img src="../assets/icon/sair.png" alt=""></a>
        </span>
    </header>

    <main>
        <div>
            <div id="categorias_mais_utilizadas" class="lateral_container" style="width: 90;">
                <h3>Ranking de categorias</h3>
            </div>
            <div id="tags_em_alta" class="lateral_container" style="width: 90%;">
                <h3>Ranking de tags</h3>
            </div>
        </div>

        <div id="posts_container" class="posts_container">
        </div>
        
        <div>
            <div id="meus_posts" class="lateral_container">
                <h3>Meus Posts</h3>
            </div>
            <div id="sites" class="lateral_container">
                <h2>Links úteis</h2>
                <a href="https://www.bibliaonline.com.br/" class="linksUteis">
                    <div><img src="../assets/icon/biblia.png">Bíblia Online - ACF</div>
                </a>
                <a href="https://www.bibliaon.com/" class="linksUteis">
                    <div><img src="../assets/icon/biblia.png">Bíblia - Bíblia Sagrada</div>
                </a>
                <a href="https://www.bible.com/pt" class="linksUteis">
                    <div><img src="../assets/icon/biblia.png">Bible.com</div>
                </a>
                <a href="https://www.escoladabiblia.com/artigos/" class="linksUteis">
                    <div><img src="../assets/icon/biblia.png">Artigos e Estudos Bíblicos</div>
                </a>
            </div>
        </div>
    </main>
    <div id="post_aberto" class="post_aberto">

    </div>

</body>

<script>
    listar()
    listarMeuPost()
    listarCategorias()
    listarTags()


    cadastroFoto.style.display = 'none';

    let fotoAberta = false;
    let fotoUsuario = '';
    let cadastrarPost = ''

    usuarioNome.innerHTML = sessionStorage.NOME_USUARIO;
    post_aberto.style.display = 'none';

    fetch(`/usuarios/dados/${sessionStorage.ID_USUARIO}`, {
        method: "GET",
    })
        .then(function (resposta) {
            resposta.json().then((dadosUsuario) => {

                perfil.innerHTML = `<a onclick="abrirFoto()">
                                <img src="${dadosUsuario.foto}" alt="" style="border-radius: 50%;">
                                </a>
                                <span id="usuarioNome">${sessionStorage.NOME_USUARIO}</span>
                                <a onclick="sair()"><img src="../assets/icon/sair.png" alt=""></a>`

                cadastrarPost = `<div class="post" style="cursor: auto;">
                                            <span><img src="${dadosUsuario.foto}" alt="">
                                                <div id="post_inputs">
                                                    <select name="" id="selCategoria" type="text">
                                                        <option value="Categoria">Categoria</option>
                                                        <option value="Pentateuco">Pentateuco</option>
                                                        <option value="Evangelhos">Evangelhos</option>
                                                        <option value="Contexto histórico e cultural">Contexto histórico e cultural</option>
                                                        <option value="Temas teológicos">Temas teológicos</option>
                                                        <option value="Trindade">Trindade</option>
                                                    </select>
                                                    <textarea placeholder="Ex: #Tag" id="iptTags"></textarea>
                                                </div>

                                                <div style="width: 100%;">
                                                    <textarea placeholder="Título do post" maxlength="55" rows="5" id="textarea_titulo"></textarea>
                                                    <textarea placeholder="Máximo de 700 caracteres." maxlength="700" rows="5"
                                                        id="textarea_conteudo"></textarea>
                                                </div>
                                                <button style="margin-left: 10px; cursor: pointer;" onclick="criarPost(), listar()">Criar
                                                    POST</button>
                                            </span>
                                        </div>`
            });
        })
        .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

    function enviar() {

        let foto = ipt_foto.value;
        let id_usuario = sessionStorage.ID_USUARIO;

        fetch("/postagem/cadastrarFoto", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                foto: foto,
                id_usuario: id_usuario
            })
        })
    }

    function abrirFoto() {
        if (fotoAberta == false) {
            cadastroFoto.style.display = 'block'
            fotoAberta = true
        } else {
            cadastroFoto.style.display = 'none'
            fotoAberta = false
        }
    }

    function sair() {

        sessionStorage.EMAIL_USUARIO = '';
        sessionStorage.NOME_USUARIO = '';
        sessionStorage.ID_USUARIO = '';

        setTimeout(() => {
            window.location = '../login.html'
        }, 100)
    }

    function listarMeuPost() {

        setTimeout(() => {

            fetch(`/postagem/listarPostUsuario/${sessionStorage.ID_USUARIO}`, {
                method: "GET",
            })
                .then(function (resposta) {

                    resposta.json().then((dadosPostagem) => {

                        let divPosts = ''
                        for (let index = 0; index < dadosPostagem.length; index++) {

                            let postagem = dadosPostagem[index]

                            divPosts += `
                                <div class="post" onclick="abrirPost(${index}, ${sessionStorage.ID_USUARIO}, ${postagem.postagem})">
                                    <span>
                                    <img src="${postagem.foto}">
                                    <p>${postagem.nome}</p>
                                    </span>
                                    <h4>${postagem.titulo}</h4>
                                    <span>
                                    <p>${postagem.data}</p>
                                    <div id="comentarios_curtidas">
                                    
                                    <p class="paragrafo"><img src="../assets/icon/comentarios.png" class="imagem">${postagem.comentarios}</p>
                                    <p class="paragrafo"><img src="../assets/icon/gostar.png" class="imagem">${postagem.curtidas}</p>
                                    </div>
                                </div>
                                `;

                            meupost[index] = postagem

                            cadastrarPost = `<div class="post" style="cursor: auto;">
                                            <span><img src="${postagem.foto}" alt="">
                                                <div id="post_inputs">
                                                    <select name="" id="selCategoria" type="text">
                                                        <option value="Categoria">Categoria</option>
                                                        <option value="Pentateuco">Pentateuco</option>
                                                        <option value="Evangelhos">Evangelhos</option>
                                                        <option value="Contexto histórico e cultural">Contexto histórico e cultural</option>
                                                        <option value="Temas teológicos">Temas teológicos</option>
                                                        <option value="Trindade">Trindade</option>
                                                    </select>
                                                    <textarea placeholder="Ex: #Tag" id="iptTags"></textarea>
                                                </div>

                                                <div style="width: 100%;">
                                                    <textarea placeholder="Título do post" maxlength="55" rows="5" id="textarea_titulo"></textarea>
                                                    <textarea placeholder="Máximo de 700 caracteres." maxlength="700" rows="5"
                                                        id="textarea_conteudo"></textarea>
                                                </div>

                                                <button style="margin-left: 10px; cursor: pointer;" onclick="criarPost(), listar()">
                                                    Criar POST
                                                </button>
                                            </span>
                                        </div>`

                            meus_posts.innerHTML = `<h1> Meus Posts </h1>`
                            meus_posts.innerHTML += divPosts;
                        }
                    })
                        .catch(function (resposta) {
                            console.log(`#ERRO: ${resposta}`);
                        });
                }, 100)
        })
    }

    let post = []
    let meupost = []

    function listar() {
        setTimeout(() => {
            fetch("/postagem/listar", {
                method: "GET",
            })
                .then(function (resposta) {
                    resposta.json().then((dadosPostagem) => {

                        let divPosts = ''
                        let contador = 0
                        for (let index = 0; index < dadosPostagem.length; index++) {

                            let postagem = dadosPostagem[index]

                            divPosts += `
                            <div class="post" onclick="abrirPost(${contador}, ${undefined}, ${postagem.postagem})">
                                <span>
                                <div>
                                <img src="${postagem.foto}">
                                <p>${postagem.nome}</p>
                                </div>
                                <h2>${postagem.titulo}</h2>
                                </span>
                                <div id="categorias_tags">
                                    <span><p class="paragrafo"><img src="../assets/icon/categories.png">${postagem.categoria}</p></span>  
                                    <span><p class="paragrafo"><img src="../assets/icon/tag.png">${postagem.tags}</p></span>
                                </div>
                                <span id="data"><p>${postagem.data}</p></span>
                                
                                <div id="comentarios_curtidas">
                                
                                    <p class="paragrafo">${postagem.comentarios} Comentarios<img src="../assets/icon/comentarios.png" class="imagem"></p>

                                    <p class="paragrafo">${postagem.curtidas} Curtidas<img src="../assets/icon/gostar.png" class="imagem"></p>
                                </div>
                            </div>
                            `;
                            post[contador] = postagem
                            contador++
                        };

                        posts_container.innerHTML = cadastrarPost;
                        posts_container.innerHTML += divPosts;
                    });
                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });
        }, 200)
    }

    function criarPost() {

        let categoria = selCategoria.value;
        let tags = iptTags.value
        let titulo = textarea_titulo.value
        let conteudo = textarea_conteudo.value
        let idusuario = sessionStorage.ID_USUARIO;

        if (categoria == 'Categoria') {
            return alert('Escolha a Categoria.')
        } else if (!tags.includes('#') || tags.length > 15) {
            return alert('A tag precisa conter "#" e ser menor que 16 caracteres !')
        } else if (!titulo.includes(' ') || !conteudo.includes(' ')) {
            return alert('Necessário conter espaços entre as palavras no título e conteúdo!')
        } 
        
        fetch("/postagem/cadastrarPost", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                categoriaJson: categoria,
                tagsJson: tags,
                tituloJson: titulo,
                conteudoJson: conteudo,
                idusuarioJson: idusuario
            })
        })

        setTimeout(() => {
            listarMeuPost(idusuario)
            listarCategorias()
            listarTags()
        }, 200)
    }

    function abrirPost(contador, idUsuario, postagem) {
        post_aberto.style.display = 'block'
        let vetorTemporario = [];

        postComentarios(postagem)

        if (idUsuario == undefined) {
            vetorTemporario = post;
        } else {
            vetorTemporario = meupost;
        }

        post_aberto.innerHTML = `<div onclick="fecharPost()" id="fechar">
                            X
                        </div>

                        <div>
                            <img style="width:50px; height: 50px; border-radius: 50%" src="${vetorTemporario[contador].foto}">
                            <h1>${vetorTemporario[contador].nome}</h1>
                        </div>

                        <div id='conteudoPost'>
                            <h1>${vetorTemporario[contador].titulo}</h1>
                            <div>
                            <p><img src="../assets/icon/categories.png">${vetorTemporario[contador].categoria}</p>
                            <p style="margin-left: 15px"><img src="../assets/icon/tag.png">${vetorTemporario[contador].tags}</p>
                            </div>
                            <p id="conteudoPostAberto">${vetorTemporario[contador].conteudo}</p>
                            <span>${vetorTemporario[contador].data}</span>
                        </div>
                        
                        <div>
                            <p class="paragrafo"
                                style="margin: 0px 20px;">
                                <img src="../assets/icon/comentarios.png" class="imagem"> <button onclick= "criarComentario(${postagem})">Comentar</button>
                            </p>
                            <p  class="paragrafo"
                                style="margin: 0px 20px;">
                                <img src="../assets/icon/gostar.png" class="imagem"> <button onclick="curtir(${postagem})">Curtir</button>
                            </p>
                        </div>

                        <div style="display: flex; flex-direction: column;">
                            <textarea name="" id="textComentario" placeholder="Compartilhe sua opiniao"
                                style="width: 50%; height: 100px;"></textarea>
                        </div>

                        <div id="comentariosDoPost">
                            <h1>Comentarios</h1>
                        </div>`
    }

    function fecharPost() {
        post_aberto.style.display = 'none'
    }

    function listarCategorias() {
        fetch("/postagem/listarCategorias", {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((dadosCategorias) => {
                    categorias_mais_utilizadas.innerHTML = '<h3>Ranking de categorias</h3>';

                    for (let index = 0; index < dadosCategorias.length; index++) {
                        let categorias = dadosCategorias[index]
                        categorias_mais_utilizadas.innerHTML += `<p id="categoria_p"><img style="width: 30px;" src="../assets/icon/filtrando.png" alt="">${categorias.categoria}</p>`
                    }
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function listarTags() {

        fetch("/postagem/listarTags", {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((dadosTags) => {

                    tags_em_alta.innerHTML = '<h3>Ranking de tags</h3>'
                    for (let index = 0; index < dadosTags.length; index++) {
                        let tags = dadosTags[index]
                        tags_em_alta.innerHTML += `<p><img src="../assets/icon/price-tag.png">${tags.nome}</p>`
                    }

                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function postComentarios(postagem) {

        fetch(`/postagem/listarComentarios/${postagem}`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((comentariosUsuario) => {

                    comentariosDoPost.innerHTML = '';
                    for (let index = 0; index < comentariosUsuario.length; index++) {
                        let comentarios = comentariosUsuario[index]
                        comentariosDoPost.innerHTML += `
                            <div class="post" style="border-bottom: 1px solid; border-top: 1px solid;">
                                <span style="align-self: flex-start;">
                                <img src="${comentarios.foto}">
                                <h2>${comentarios.nome}</h2>
                                </span>
                                <span>
                                <h3>${comentarios.data}</h3>
                                <p>${comentarios.conteudo}</p>
                                </span
                            </div>`
                    }
                });
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function criarComentario(postagem) {
        let conteudo = textComentario.value
        let idusuario = sessionStorage.ID_USUARIO;
        let idpostagem = postagem;

        if (conteudo == '') {
            alert('O comentário não pode estar vázio!')
        } else {
            textComentario.value = ''
            fetch("/postagem/criarComentario", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    conteudo: conteudo,
                    idusuario: idusuario,
                    idpostagem: idpostagem
                })
            })
        }

        setTimeout(() => {
            postComentarios(idpostagem)
            listar()
        }, 200)

    }

    function curtir(postagem) {
        let idusuario = sessionStorage.ID_USUARIO;
        let idpostagem = postagem

        fetch("/postagem/curtir", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idusuario: idusuario,
                idpostagem: idpostagem
            })
        })

        setTimeout(() => {
            postComentarios(idpostagem)
            listar()
        }, 200)

    }

</script>

</html>